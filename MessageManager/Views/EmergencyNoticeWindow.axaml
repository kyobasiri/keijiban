<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:MessageManager.ViewModels"
        xmlns:i="using:Avalonia.Xaml.Interactivity"
        xmlns:behaviors="using:Avalonia.Xaml.Interactions.Core"
        xmlns:core="using:Avalonia.Xaml.Interactions.Core"
        xmlns:localBehaviors="using:MessageManager.Behaviors"
        xmlns:converters="clr-namespace:MessageManager.Converters"
        x:Class="MessageManager.Views.EmergencyNoticeWindow"
        x:DataType="vm:EmergencyNoticeViewModel"
        Title="緊急連絡事項管理"
        Width="1600" Height="900"
        WindowStartupLocation="CenterScreen">

  
  <Design.DataContext>
    <vm:EmergencyNoticeViewModel/>
  </Design.DataContext>

  <Window.Resources>
    <converters:PriorityToStringConverter x:Key="PriorityToStringConverter"/>
  </Window.Resources>

  <Window.Styles>
    <!-- ヘッダースタイル -->
    <Style Selector="Border.Header">
      <Setter Property="Background" Value="#4682B4"/>
      <Setter Property="Padding" Value="15,10"/>
    </Style>

    <Style Selector="TextBlock.HeaderTitle">
      <Setter Property="FontSize" Value="18"/>
      <Setter Property="FontWeight" Value="Bold"/>
      <Setter Property="Foreground" Value="White"/>
    </Style>

    <!-- セクションヘッダー -->
    <Style Selector="Border.SectionHeader">
      <Setter Property="Background" Value="#E8F4FD"/>
      <Setter Property="BorderBrush" Value="#4682B4"/>
      <Setter Property="BorderThickness" Value="0,0,0,2"/>
      <Setter Property="Padding" Value="10,8"/>
    </Style>

    <!-- フォームスタイル -->
    <Style Selector="TextBox.FormInput">
      <Setter Property="Padding" Value="8"/>
      <Setter Property="Margin" Value="0,0,30,0"/>
      <Setter Property="BorderBrush" Value="#CCCCCC"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="FontSize" Value="12"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="MinHeight" Value="34"/>
    </Style>

    <Style Selector="ComboBox.FormSelect">
      <Setter Property="Padding" Value="8"/>
      <Setter Property="Margin" Value="0,0,30,0"/>
      <Setter Property="BorderBrush" Value="#CCCCCC"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="FontSize" Value="12"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="MinHeight" Value="34"/>
    </Style>

    <Style Selector="TextBlock.FormLabel">
      <Setter Property="FontWeight" Value="Bold"/>
      <Setter Property="Margin" Value="0,0,10,0"/>
      <Setter Property="FontSize" Value="13"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
    </Style>

    <!-- ボタンスタイル -->
    <Style Selector="Button.PrimaryButton">
      <Setter Property="Background" Value="#28a745"/>
      <Setter Property="Foreground" Value="White"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Padding" Value="22,15"/>
      <Setter Property="FontWeight" Value="Bold"/>
      <Setter Property="Margin" Value="0,0,10,0"/>
      <Setter Property="MinHeight" Value="38"/>
      <Setter Property="FontSize" Value="16"/>
    </Style>

    <Style Selector="Button.PrimaryButton:disabled">
      <Setter Property="Background" Value="#6c757d"/>
    </Style>

    <Style Selector="Button.EditButton">
      <Setter Property="Background" Value="#ff6b35"/>
      <Setter Property="Foreground" Value="White"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Padding" Value="15,10"/>
      <Setter Property="FontWeight" Value="Bold"/>
      <Setter Property="Margin" Value="0,0,10,0"/>
      <Setter Property="MinHeight" Value="38"/>
    </Style>

    <Style Selector="Button.SecondaryButton">
      <Setter Property="Background" Value="#6c757d"/>
      <Setter Property="Foreground" Value="White"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Padding" Value="12,8"/>
      <Setter Property="Margin" Value="0,0,10,0"/>
    </Style>

    <Style Selector="Button.ActionButton">
      <Setter Property="Background" Value="#007bff"/>
      <Setter Property="Foreground" Value="White"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Padding" Value="10,5"/>
      <Setter Property="FontSize" Value="13"/>
      <Setter Property="Margin" Value="2"/>
    </Style>

    <!-- 履歴リストアイテム -->
    <Style Selector="Border.HistoryListItem">
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Padding" Value="12,10"/>
      <Setter Property="Margin" Value="0,0,0,4"/>
    </Style>

    <Style Selector="Border.HistoryListItem.Active">
      <Setter Property="Background" Value="#E3F2FD"/>
      <Setter Property="BorderBrush" Value="#2196F3"/>
    </Style>

    <Style Selector="Border.HistoryListItem.Inactive">
      <Setter Property="Background" Value="#f5f5f5"/>
      <Setter Property="BorderBrush" Value="#CCCCCC"/>
    </Style>

    <Style Selector="Border.HistoryListItem.Editing">
      <Setter Property="Background" Value="#1e3a8a"/>
      <Setter Property="BorderBrush" Value="#dc3545"/>
      <Setter Property="BorderThickness" Value="2"/>
    </Style>

    <!-- バッジスタイル -->
    <Style Selector="Border.StatusBadge">
      <Setter Property="CornerRadius" Value="12"/>
      <Setter Property="Padding" Value="10,5"/>
      <Setter Property="Margin" Value="0,0,8,0"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
    </Style>

    <!-- 詳細パネル -->
    <Style Selector="Border.DetailPanel">
      <Setter Property="Background" Value="White"/>
      <Setter Property="BorderBrush" Value="#DDDDDD"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Padding" Value="20"/>
    </Style>

    <!-- 部署タグスタイル -->
    <Style Selector="Border.DepartmentTag">
      <Setter Property="Background" Value="#E3F2FD"/>
      <Setter Property="BorderBrush" Value="#2196F3"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Padding" Value="8,4"/>
      <Setter Property="Margin" Value="0,0,6,4"/>
    </Style>

    <!-- 有効無効切り替えボタン -->
    <Style Selector="Button.ToggleButton">
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="BorderBrush" Value="#dee2e6"/>
      <Setter Property="Padding" Value="10,5"/>
      <Setter Property="FontSize" Value="13"/>
      <Setter Property="Margin" Value="1"/>
      <Setter Property="MinWidth" Value="50"/>
    </Style>

    <!-- 無効化されたボタンのスタイルをオーバーライド -->
    <Style Selector="Button.ToggleButton:disabled">
      <Setter Property="Opacity" Value="1"/>
    </Style>

      <Style Selector="Button.ClearButton">
        <Setter Property="Background" Value="#6c757d"/>
        <Setter Property="Foreground" Value="White"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="CornerRadius" Value="4"/>
        <Setter Property="Padding" Value="22,10"/>
        <Setter Property="FontWeight" Value="Bold"/>
        <Setter Property="Margin" Value="0,0,10,0"/>
        <Setter Property="MinHeight" Value="20"/>
        <Setter Property="FontSize" Value="13"/>
      </Style>
  </Window.Styles>

  <Grid RowDefinitions="Auto,Auto,*">
    <!-- ヘッダー -->
    <Border Grid.Row="0" Classes="Header">
      <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
        <TextBlock Classes="HeaderTitle" Text="緊急連絡事項管理"/>
        <Button Content="×閉じる" Background="Transparent"
                Foreground="White" BorderThickness="0"
                Margin="20,0,0,0" FontSize="14"
                Command="{Binding CloseWindowCommand}"/>
      </StackPanel>
    </Border>

    <!-- 入力エリア -->
    <Border Grid.Row="1" Classes="DetailPanel" Margin="15,15,15,10">
      <Grid RowDefinitions="Auto,Auto,Auto">
        <Border Grid.Row="0" Classes="SectionHeader">
          <StackPanel Orientation="Horizontal">
            <TextBlock Text="緊急連絡事項登録" FontWeight="Bold" FontSize="16" Foreground="#4682B4"/>
          </StackPanel>
        </Border>

        <!-- 1行目：全フィールド横並び -->
        <Grid Grid.Row="1"
              ColumnDefinitions="Auto,140,Auto,160,Auto,220,Auto,*,Auto"
              Margin="0,20,0,10">

          <!-- 重要度 -->
          <TextBlock Grid.Column="0" Classes="FormLabel" Text="重要度:"/>
          <ComboBox Grid.Column="1" Classes="FormSelect"
                    ItemsSource="{Binding PriorityOptions}"
                    SelectedItem="{Binding SelectedPriority}">
            <ComboBox.ItemTemplate>
              <DataTemplate>
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="{Binding Converter={StaticResource PriorityToStringConverter}}" Margin="0,0,4,0"/>
                  <TextBlock Text="{Binding}" FontSize="10" Foreground="#666"/>
                </StackPanel>
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>

          <!-- 連絡事項の種類 -->
          <TextBlock Grid.Column="2" Classes="FormLabel" Text="種類:"/>
          <TextBox Grid.Column="3" Classes="FormInput"
                   Text="{Binding NoticeType}"
                   Watermark="例: C対応, 設備点検"/>

          <!-- 対象部署 -->
          <TextBlock Grid.Column="4" Classes="FormLabel" Text="対象部署:"/>
          <ComboBox Grid.Column="5" Classes="FormSelect"
              ItemsSource="{Binding Departments}"
              PlaceholderText="{Binding TargetDepartmentDisplay}"
              x:Name="TargetDepartmentComboBox">
            <i:Interaction.Behaviors>
              <core:EventTriggerBehavior EventName="SelectionChanged" SourceObject="{Binding #TargetDepartmentComboBox}">
                <core:InvokeCommandAction Command="{Binding OnDepartmentSelectionChangedCommand}"
                                          CommandParameter="{Binding #TargetDepartmentComboBox.SelectedItem}" />
                <core:ChangePropertyAction TargetObject="{Binding #TargetDepartmentComboBox}" PropertyName="SelectedItem" Value="{x:Null}" />
              </core:EventTriggerBehavior>
            </i:Interaction.Behaviors>

            <ComboBox.ItemTemplate>
              <DataTemplate x:DataType="vm:DepartmentViewModel">
                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>

          <!-- 連絡事項内容 -->
          <TextBlock Grid.Column="6" Classes="FormLabel" Text="内容:"/>
          <TextBox Grid.Column="7" Classes="FormInput"
                   Text="{Binding NoticeContent}"
                   Watermark="連絡事項の詳細内容"/>

          <!-- 登録/変更ボタン -->
          <Button Grid.Column="8"
                  Content="登録"
                  Classes="PrimaryButton"
                  Command="{Binding RegisterNoticeCommand}"/>          
        </Grid>

        <!-- 2行目：選択された対象部署一覧（小さめ表示） -->
        <Grid Grid.Row="2"
              ColumnDefinitions="Auto,140,Auto,160,Auto,220,Auto,*,Auto"
              Margin="0,0,0,10">

          <StackPanel Grid.Column="1" Grid.ColumnSpan="7"
                      Orientation="Horizontal"
                      IsVisible="{Binding !IsAllDepartments}"
                      VerticalAlignment="Center">

            <TextBlock Text="選択中:" FontSize="11" Foreground="#666"
                       VerticalAlignment="Center" Margin="0,0,8,0"/>

            <ItemsControl ItemsSource="{Binding SelectedTargetDepartments}">
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:TargetDepartmentViewModel">
                  <Border Background="#E3F2FD" BorderBrush="#2196F3" BorderThickness="1"
                          CornerRadius="3" Padding="6,2" Margin="0,0,4,2">
                    <StackPanel Orientation="Horizontal">
                      <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontSize="10"/>
                      <Button Content="×" Background="Transparent" Foreground="#dc3545"
                              BorderThickness="0" Padding="2,0" Margin="4,0,0,0"
                              Command="{Binding RemoveTargetDepartmentCommand}" FontSize="9"/>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <WrapPanel/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
            </ItemsControl>
          </StackPanel>

          <Button Grid.Column="8"
                  Content="クリア"
                  Classes="ClearButton"
                  Command="{Binding ClearFormCommand}"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Top"/>
        </Grid>
      </Grid>
    </Border>

    <!-- 履歴一覧 -->
    <Border Grid.Row="2" Classes="DetailPanel" Margin="15,10,15,15">
      <Grid RowDefinitions="Auto,*">
        <Border Grid.Row="0" Classes="SectionHeader">
          <Grid ColumnDefinitions="*,Auto">
            <TextBlock Grid.Column="0" Text="登録履歴" FontWeight="Bold" FontSize="16" Foreground="#4682B4"/>
            <Button Grid.Column="1" Classes="ActionButton" Content="最新情報取得"
                    Command="{Binding RefreshDataCommand}"/>
          </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,15,0,0">
          <ItemsControl ItemsSource="{Binding EmergencyNotices}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:EmergencyNoticeItemViewModel">
                <Border Classes="HistoryListItem"
                        Classes.Active="{Binding IsActive}"
                        Classes.Inactive="{Binding !IsActive}"
                        >

                  <!-- 一行レイアウト：日時、重要度、種類、対象部署、内容、ボタン類 -->
                  <Grid ColumnDefinitions="120,80,120,300,*,Auto">

                    <!-- 作成日時 -->
                    <TextBlock Grid.Column="0" Text="{Binding CreatedAtDisplay}"
                               FontSize="12" FontWeight="SemiBold"
                               Margin="0,0,10,0" VerticalAlignment="Center"/>

                    <!-- 重要度バッジ -->
                    <Border Grid.Column="1" Classes="StatusBadge" Background="{Binding PriorityColor}">
                      <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="{Binding PriorityIcon}" Foreground="White" FontSize="13" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding PriorityDisplay}" Foreground="White" FontSize="13"
                                   Margin="3,0,0,0" VerticalAlignment="Center"/>
                      </StackPanel>
                    </Border>

                    <!-- 連絡事項種類 -->
                    <Border Grid.Column="2" Background="#F8F9FA" CornerRadius="4" Padding="8,4"
                            Margin="0,0,10,0" VerticalAlignment="Center">
                      <TextBlock Text="{Binding NoticeType}" FontSize="11" FontWeight="Bold"
                                 Foreground="#495057" VerticalAlignment="Center" TextAlignment="Center"/>
                    </Border>

                    <!-- 対象部署 -->
                    <Border Grid.Column="3" Background="#E9ECEF" CornerRadius="4" Padding="8,4"
                            Margin="0,0,10,0" VerticalAlignment="Center">
                      <TextBlock Text="{Binding TargetDepartmentNames}" FontSize="11"
                                 Foreground="#6C757D" VerticalAlignment="Center" TextAlignment="Center"/>
                    </Border>

                    <!-- 連絡事項内容 -->
                    <TextBlock Grid.Column="4" Text="{Binding NoticeContent}" FontSize="12"
                               TextWrapping="Wrap" VerticalAlignment="Center" Margin="0,0,10,0"/>

                    <!-- 有効無効状態 -->
                    <StackPanel Grid.Column="5" Orientation="Horizontal" VerticalAlignment="Center">
                      <Button Classes="ToggleButton" Content="{Binding InactiveButtonText}"
                              Background="{Binding InactiveButtonColor}"
                              Foreground="{Binding InactiveButtonTextColor}"
                              Command="{Binding $parent[Window].((vm:EmergencyNoticeViewModel)DataContext).ToggleNoticeCommand}"
                              CommandParameter="{Binding}"/>
                      <Button Classes="ActionButton" Content="コピー"
                              Command="{Binding $parent[Window].((vm:EmergencyNoticeViewModel)DataContext).CopyToFormCommand}"
                              CommandParameter="{Binding}"
                              ToolTip.Tip="フォームにコピー"/>
                    </StackPanel>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>

        <!-- ローディング表示 -->
        <TextBlock Grid.Row="1" Text="読み込み中..." HorizontalAlignment="Center"
                   VerticalAlignment="Center" IsVisible="{Binding IsLoading}"/>

        <!-- データがない場合の表示 -->
        <StackPanel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                    IsVisible="{Binding IsEmptyList}">
          <TextBlock Text="📋" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,10"/>
          <TextBlock Text="まだ緊急連絡事項が登録されていません" FontSize="16"
                     Foreground="#666666" HorizontalAlignment="Center"/>
        </StackPanel>
      </Grid>
    </Border>
  </Grid>
</Window>
